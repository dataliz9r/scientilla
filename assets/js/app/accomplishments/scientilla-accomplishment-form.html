<div class="modal-header">
    <h3>{{ !!vm.accomplishment.id ? 'Edit' : 'Add a new' }} accomplishment</h3>
    <button
        type="button"
        class="close"
        ng-click="vm.cancel()">
        <i class="fas fa-times"></i>
    </button>
</div>

<div class="modal-body">
    <form
        name="form"
        class="{{vm.status.class}}"
        autocomplete="off">

        <div ng-if="vm.accomplishment.type == 'editor'">
            <div class="row">
                <div class="col-12 col-sm-6">
                    <div class="form-group">
                        <label for="accomplishmentType">Accomplishment Type *</label>
                        <div class="select-wrapper">
                            <select
                                class="form-control"
                                id="accomplishmentType"
                                placeholder="Accomplishment Type"
                                ng-model="vm.accomplishment.type"
                                ng-options="option.key as option.label for option in vm.types"
                                ng-change="vm.resetErrors()">
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-sm-6">
                    <div
                        class="form-group has-feedback"
                            ng-class="{
                            'has-error' : vm.errors.sourceType && vm.mode == 'verify',
                            'has-warning' : vm.errors.sourceType && vm.mode == 'draft'
                        }">
                        <label for="sourceType">Source Type *</label>
                        <div
                            class="select-wrapper"
                            ng-class="{'is-invalid' : vm.errors.sourceType}">
                            <select
                                class="form-control"
                                id="sourceType"
                                name="sourceType"
                                required
                                placeholder="Source Type"
                                ng-model="vm.accomplishment.sourceType"
                                ng-model-options="{ allowInvalid: true }"
                                ng-options="option.id as option.label group by option.section for option in vm.sourceTypes"
                                ng-class="{'is-invalid' : vm.errors.sourceType}"
                                ng-blur="vm.checkValidation('sourceType')"
                                ng-change="vm.checkValidation('sourceType')">
                                <option value="">--Not Selected--</option>
                            </select>
                        </div>
                        <scientilla-error-messages
                            class="error-messages"
                            errors="vm.errors.sourceType"></scientilla-error-messages>
                    </div>
                </div>

                <div class="col-12 col-sm-6">
                    <div
                        class="form-group has-feedback"
                        ng-class="{
                            'has-error' : vm.errors.source && vm.mode == 'verify',
                            'has-warning' : vm.errors.source && vm.mode == 'draft'
                        }">
                        <label for="source">{{ vm.sourceLabel }} *</label>
                        <div
                            class="input-group"
                            ng-class="{'is-invalid' : vm.errors.source}">
                            <input
                                id="source"
                                name="source"
                                type="text"
                                ng-model="vm.accomplishment.source"
                                class="form-control"
                                uib-typeahead="source as source.title for source in vm.getSources($viewValue)"
                                typeahead-loading="searching"
                                typeahead-no-results="noResults"
                                data-ng-required="true"
                                placeholder="{{vm.sourceLabel}}"
                                ng-model-options="{ allowInvalid: true }"
                                typeahead-editable="false"
                                typeahead-select-on-blur="true"
                                ng-blur="vm.checkSource($event)"
                                ng-change="vm.fieldValueHasChanged('source')"
                                ng-class="{'is-invalid' : vm.errors.source}">
                            {{ $viewValue }}
                            <div class="input-group-append">
                                <button
                                    ng-click="vm.openSourceTypeModal($event)"
                                    type="button"
                                    class="btn btn-outline-secondary">Add New</button>
                            </div>
                        </div>
                        <scientilla-error-messages
                            class="error-messages"
                            errors="vm.errors.source"></scientilla-error-messages>
                    </div>
                </div>

                <div class="col-12 col-sm-6">
                    <div
                        ng-class="{
                            'has-error' : vm.errors.yearFrom && vm.mode == 'verify',
                            'has-warning' : vm.errors.yearFrom && vm.mode == 'draft'
                        }"
                        class="form-group has-feedback">
                        <label for="yearFrom">Year from (YYYY format) *</label>
                        <input
                            type="text"
                            name="yearFrom"
                            class="form-control"
                            id="yearFrom"
                            placeholder="Year"
                            ng-model="vm.accomplishment.yearFrom"
                            data-ng-required="true"
                            ng-pattern="/^(19|20)\d{2}$/"
                            ng-model-options="{ allowInvalid: true }"
                            ng-class="{'is-invalid' : vm.errors.yearFrom}"
                            ng-blur="vm.checkValidation('yearFrom')"
                            ng-change="vm.fieldValueHasChanged('yearFrom')">
                        <scientilla-error-messages
                            class="error-messages"
                            errors="vm.errors.yearFrom"></scientilla-error-messages>
                    </div>
                </div>

                <div class="col-12 col-sm-6">
                    <div
                        ng-class="{
                            'has-error' : vm.errors.yearTo && vm.mode == 'verify',
                            'has-warning' : vm.errors.yearTo && vm.mode == 'draft'
                        }"
                        class="form-group has-feedback">
                        <label for="yearTo">Year to (YYYY format) *</label>
                        <input
                            type="text"
                            name="yearTo"
                            class="form-control"
                            id="yearTo"
                            placeholder="Year"
                            ng-model="vm.accomplishment.yearTo"
                            data-ng-required="true"
                            ng-pattern="/^(19|20)\d{2}$/"
                            ng-model-options="{ allowInvalid: true }"
                            ng-class="{'is-invalid' : vm.errors.yearTo}"
                            ng-blur="vm.checkValidation('yearTo')"
                            ng-change="vm.fieldValueHasChanged('yearTo')">
                        <scientilla-error-messages
                            class="error-messages"
                            errors="vm.errors.yearTo"></scientilla-error-messages>
                    </div>
                </div>

                <div
                    class="col-12"
                    ng-class="{
                        'has-error' : vm.errors.authorsStr && vm.mode == 'verify',
                        'has-warning' : vm.errors.authorsStr && vm.mode == 'draft'
                    }"
                    class="form-group has-feedback">
                    <label for="authors">Authors (must be in the form "Doe J., Smith Simpson J. V.") *</label>
                    <input
                        type="text"
                        name="authors"
                        class="form-control"
                        id="authors"
                        placeholder="Authors"
                        ng-model="vm.accomplishment.authorsStr"
                        ng-pattern="vm.accomplishmentFieldsRules.authorsStr.regex"
                        data-ng-required="true"
                        ng-model-options="{ allowInvalid: true }"
                        ng-class="{'is-invalid' : vm.errors.authorsStr}"
                        ng-blur="vm.checkValidation('authorsStr')"
                        ng-change="vm.fieldValueHasChanged('authorsStr')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.authorsStr"></scientilla-error-messages>
                </div>
            </div>
        </div>

        <div class="row" ng-if="vm.accomplishment.type == 'award'">
            <div class="col-12 col-sm-6">
                <div class="form-group">
                    <label for="accomplishmentType">Accomplishment Type *</label>
                    <div class="select-wrapper">
                        <select
                            class="form-control"
                            id="accomplishmentType"
                            placeholder="Accomplishment Type"
                            ng-model="vm.accomplishment.type"
                            ng-options="option.key as option.label for option in vm.types"
                            ng-change="vm.resetErrors()">
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6">
                <div
                    ng-class="{
                    'has-error' : vm.errors.title && vm.mode == 'verify',
                    'has-warning' : vm.errors.title && vm.mode == 'draft'
                }"
                    class="form-group has-feedback">
                    <label for="title">Title *</label>
                    <input
                        name="title"
                        type="text"
                        class="form-control"
                        id="title"
                        placeholder="Title"
                        ng-model="vm.accomplishment.title"
                        data-ng-required="true"
                        ng-class="{'is-invalid' : vm.errors.title}"
                        ng-blur="vm.checkValidation('title')"
                        ng-change="vm.fieldValueHasChanged('title')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.title"></scientilla-error-messages>
                </div>
            </div>

            <div class="col-12">
                <div
                    ng-class="{
                        'has-error' : vm.errors.authorsStr && vm.mode == 'verify',
                        'has-warning' : vm.errors.authorsStr && vm.mode == 'draft'
                    }"
                    class="form-group has-feedback">
                    <label for="authors">Authors (must be in the form "Doe J., Smith Simpson J. V.") *</label>
                    <input
                        type="text"
                        name="authors"
                        class="form-control"
                        id="authors"
                        placeholder="Authors"
                        ng-model="vm.accomplishment.authorsStr"
                        ng-pattern="vm.accomplishmentFieldsRules.authorsStr.regex"
                        data-ng-required="true"
                        ng-model-options="{ allowInvalid: true }"
                        ng-class="{'is-invalid' : vm.errors.authorsStr}"
                        ng-blur="vm.checkValidation('authorsStr')"
                        ng-change="vm.fieldValueHasChanged('authorsStr')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.authorsStr"></scientilla-error-messages>
                </div>
            </div>

            <div class="col-12 col-sm-6">
                <div class="form-group">
                    <label for="issuer">Issuer</label>
                    <input
                        type="text"
                        class="form-control"
                        id="issuer"
                        placeholder="Issuer"
                        ng-model="vm.accomplishment.issuer">
                </div>
            </div>

            <div class="col-12 col-sm-6">
                <div class="form-group">
                    <scientilla-multicomplete
                        items="vm.accomplishment.affiliations"
                        query="vm.getInstitutesQuery"
                        filter="vm.getInstitutesFilter"
                        title="Affiliations">
                    </scientilla-multicomplete>
                </div>
            </div>
        </div>

        <div class="row" ng-if="vm.accomplishment.type == 'event'">
            <div class="col-12 col-sm-6">
                <div class="form-group">
                    <label for="accomplishmentType">Accomplishment Type *</label>
                    <div class="select-wrapper">
                        <select
                            class="form-control"
                            id="accomplishmentType"
                            placeholder="Accomplishment Type"
                            ng-model="vm.accomplishment.type"
                            ng-options="option.key as option.label for option in vm.types"
                            ng-change="vm.resetErrors()">
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6">
                <div
                    ng-class="{
                        'has-error' : vm.errors.year && vm.mode == 'verify',
                        'has-warning' : vm.errors.year && vm.mode == 'draft'
                    }"
                    class="form-group has-feedback">
                    <label for="year">Year (YYYY format) *</label>
                    <input
                        type="text"
                        name="year"
                        class="form-control"
                        id="year"
                        placeholder="Year"
                        ng-model="vm.accomplishment.year"
                        data-ng-required="true"
                        ng-pattern="/^(19|20)\d{2}$/"
                        ng-model-options="{ allowInvalid: true }"
                        ng-class="{'is-invalid' : vm.errors.year}"
                        ng-blur="vm.checkValidation('year')"
                        ng-change="vm.fieldValueHasChanged('year')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.year"></scientilla-error-messages>
                </div>
            </div>

            <div class="col-12">
                <div
                    ng-class="{
                        'has-error' : vm.errors.title && vm.mode == 'verify',
                        'has-warning' : vm.errors.title && vm.mode == 'draft'
                    }"
                    class="form-group has-feedback">
                    <label for="title">Title *</label>
                    <input
                        name="title"
                        type="text"
                        class="form-control"
                        id="title"
                        placeholder="Title"
                        ng-model="vm.accomplishment.title"
                        data-ng-required="true"
                        ng-class="{'is-invalid' : vm.errors.title}"
                        ng-blur="vm.checkValidation('title')"
                        ng-change="vm.fieldValueHasChanged('title')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.title"></scientilla-error-messages>
                </div>
            </div>

            <div class="col-12">
                <div
                    ng-class="{
                        'has-error' : vm.errors.authorsStr && vm.mode == 'verify',
                        'has-warning' : vm.errors.authorsStr && vm.mode == 'draft'
                    }"
                    class="form-group has-feedback">
                    <label for="authors">Authors (must be in the form "Doe J., Smith Simpson J. V.") *</label>
                    <input
                        type="text"
                        name="authors"
                        class="form-control"
                        id="authors"
                        placeholder="Authors"
                        ng-model="vm.accomplishment.authorsStr"
                        ng-pattern="vm.accomplishmentFieldsRules.authorsStr.regex"
                        data-ng-required="true"
                        ng-model-options="{ allowInvalid: true }"
                        ng-class="{'is-invalid' : vm.errors.authorsStr}"
                        ng-blur="vm.checkValidation('authorsStr')"
                        ng-change="vm.fieldValueHasChanged('authorsStr')">
                    <scientilla-error-messages
                        class="error-messages"
                        errors="vm.errors.authorsStr"></scientilla-error-messages>
                </div>
            </div>

            <div class="col-12">
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea
                        rows="6"
                        class="form-control"
                        id="description"
                        placeholder="Description"
                        ng-model="vm.accomplishment.description"></textarea>
                </div>
            </div>
        </div>

        <ul class="modal-buttons">
            <li>
                <scientilla-button
                    type="button"
                    click="vm.tryToSave()"
                    ng-disabled="vm.saveStatus.state !== 'ready to save' || !vm.unsavedData">{{ vm.saveStatus.message }}
                </scientilla-button>
            </li>
            <li>
                <scientilla-button
                    type="submit"
                    ng-disabled="vm.verifyStatus.state !== 'ready to verify'"
                    click="vm.verify()">{{ vm.verifyStatus.message }}
                </scientilla-button>
            </li>
            <li>
                <scientilla-button
                    type="cancel"
                    click="vm.cancel()">Close</scientilla-button>
            </li>
        </ul>

        <div
            ng-if="vm.errorText"
            class="modal-error"
            ng-class="{
                'text-danger' : vm.mode == 'verify',
                'text-warning': vm.mode == 'draft'
            }">
            {{ vm.errorText }}
        </div>
    </form>
</div>